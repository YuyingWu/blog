

<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="renderer" content="webkit">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="description" content="">

	
<link rel="stylesheet" href="/blog//css/post.css">


	<title>GraphQL小记 - 伍酱</title>

	<!--[if lte IE 8]>
        <script>
            (function(){
                var e="abbr,article,aside,audio,canvas,datalist,details,dialog,eventsource,figure,footer,header,hgroup,mark,menu,meter,nav,output,progress,section,time,video".split(","),
                i=e.length;
                while(i--){document.createElement(e[i])}
             })();
        </script>
    <![endif]-->
</head>
<body class="page-post">

<script async>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-74424222-1', 'auto');
	ga('send', 'pageview');
</script>


<!--[if lte IE 8]>
    <p class="browserupgrade">貌似你还在用<strong>低版本IE</strong>浏览器喔~ 为了更好的体验，去下载一个<a href="https://www.baidu.com/s?ie=utf-8&f=8&rsv_bp=0&rsv_idx=1&tn=baidu&wd=chrome&rsv_pq=c275ed8c0000204b&rsv_t=b404%2BiFxvZfvn%2FqqBMyJKwHyShj%2FipQgL7TfJsGKrHxZhoWCUisbVukJsNw&rqlang=cn&rsv_enter=1&rsv_sug3=6&rsv_sug1=5&rsv_sug7=100&rsv_sug2=0&inputT=891&rsv_sug4=891" target="_blank">最新版Chrome</a>吧 ：）</p>
<![endif]-->


	<header>
	<section class="u-clearfix header__container">
		<nav class="grid-r header__nav--list">
			
				<a href="/blog/">Blog</a>
			
				<a href="/blog/archives/">Archive</a>
			
				<a href="/blog/about.html">About</a>
			
		</nav>

		<h1 class="grid">
			<a href="/">伍酱</a>
		</h1>
	</section>
</header><!-- /header -->


<div id="content">
	<div class="center">
		<div class="main-col">
			
	
	<article class="article article-detail post article-post">
	<div class="post-content">
		<header>
			
	
		
			<h1 class="title" data-role="articleTitle">GraphQL小记</h1>
		
	

			<div class="post__meta">
	<time datetime="2018-06-26T13:32:09.000Z">2018-06-26</time>

	
</div>
			
		</header>

		<div class="entry">
			<aside class="wgt-toc">
				<header>
					<p><i class="iconfont icon-folder"></i>&nbsp;文章大纲</p>
				</header>
				<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Server"><span class="toc-number">1.</span> <span class="toc-text">Server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境"><span class="toc-number">1.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义Book的Schema"><span class="toc-number">1.2.</span> <span class="toc-text">定义Book的Schema</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义RootQuery"><span class="toc-number">1.3.</span> <span class="toc-text">定义RootQuery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#打开服务器的GraphiQL的面板"><span class="toc-number">1.4.</span> <span class="toc-text">打开服务器的GraphiQL的面板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Graphql提供的类型-方法"><span class="toc-number">1.5.</span> <span class="toc-text">Graphql提供的类型/方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关联类型（relative-type）"><span class="toc-number">1.6.</span> <span class="toc-text">关联类型（relative type）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mutation"><span class="toc-number">1.7.</span> <span class="toc-text">Mutation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Client"><span class="toc-number">2.</span> <span class="toc-text">Client</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境-1"><span class="toc-number">2.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-1：连接React-component和Apollo-Provider"><span class="toc-number">2.2.</span> <span class="toc-text">Step 1：连接React component和Apollo Provider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-2：graphql-query和React组件的数据交互"><span class="toc-number">2.3.</span> <span class="toc-text">Step 2：graphql query和React组件的数据交互</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-声明graphql-query"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.声明graphql query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-利用Apollo连接gq-query和react-component"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.利用Apollo连接gq query和react component</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-通过this-props-data获取请求数据"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.通过this.props.data获取请求数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Mutation"><span class="toc-number">2.3.4.</span> <span class="toc-text">4. Mutation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Query"><span class="toc-number">2.3.5.</span> <span class="toc-text">5. Query</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tips"><span class="toc-number">3.</span> <span class="toc-text">Tips</span></a></li></ol>
			</aside>
			<p><img src="http://sinacloud.net/woodysblog/graphql/structure.png" alt="&quot;structure&quot;"></p>
<p>基于GraphQL、express、MongoDB、Apollo、React.js的小应用。<br>-&gt;&gt; 项目源码<a href="https://github.com/YuyingWu/playground/tree/master/graphql-playlist" target="_blank" rel="noopener">github传送门</a></p>
<p>内容包括：</p>
<ul>
<li>如何搭建基于GraphQL、express、MongoDB的后台服务器</li>
<li>如何定义数据模型</li>
<li>如何通过GraphiQL测试query和获取的数据结构，包括query（查询）和mutation（更新）</li>
<li>如何搭建可以跟graphql query通信的Apollo-React前端应用</li>
</ul>
<a id="more"></a>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>express<ul>
<li>express-graphql</li>
</ul>
</li>
<li>graphql</li>
<li>mongoose，连接server和数据库（mLab）</li>
<li><a href="https://mlab.com/" target="_blank" rel="noopener">mLab</a>，云端mongoDB</li>
</ul>
<h3 id="定义Book的Schema"><a href="#定义Book的Schema" class="headerlink" title="定义Book的Schema"></a>定义Book的Schema</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// schema.js</span></span><br><span class="line"><span class="keyword">const</span> graphql = <span class="built_in">require</span>(<span class="string">'graphql'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; GraphQLObjectType, GraphQLString &#125; = graphql;</span><br><span class="line"><span class="keyword">const</span> BookType = <span class="keyword">new</span> GraphQLObjectType(&#123;</span><br><span class="line">  name: <span class="string">'Book'</span>,</span><br><span class="line">  fields: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    id: &#123; <span class="keyword">type</span>: GraphQLString &#125;,</span><br><span class="line">    genre: &#123; <span class="keyword">type</span>: GraphQLString &#125;,</span><br><span class="line">    name: &#123; <span class="keyword">type</span>: GraphQLString &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="定义RootQuery"><a href="#定义RootQuery" class="headerlink" title="定义RootQuery"></a>定义RootQuery</h3><ul>
<li>book的类型是一个Graphql对象类型<code>BookType</code>；</li>
<li>args是发起这个query时，需要传入什么参数，这里是<code>id</code>；</li>
<li>resolve是根据参数从数据库查询数据的逻辑。</li>
</ul>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// schema.js</span></span><br><span class="line"><span class="keyword">const</span> RootQuery = <span class="keyword">new</span> GraphQLObjectType(&#123;</span><br><span class="line">  <span class="attribute">name</span>: <span class="string">'RootQueryType'</span>,</span><br><span class="line">  <span class="attribute">fields</span>: &#123;</span><br><span class="line">    <span class="attribute">book</span>: &#123;</span><br><span class="line">      <span class="attribute">type</span>: BookType,</span><br><span class="line">      <span class="attribute">args</span>: &#123;</span><br><span class="line">        <span class="attribute">id:</span><span class="string"> &#123; type</span>: GraphQLString &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      resolve(<span class="built_in">parent</span>, args) &#123;</span><br><span class="line">        <span class="comment">// code to get data from db / other source</span></span><br><span class="line">        <span class="comment">// args.id</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="打开服务器的GraphiQL的面板"><a href="#打开服务器的GraphiQL的面板" class="headerlink" title="打开服务器的GraphiQL的面板"></a>打开服务器的GraphiQL的面板</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="comment">// 访问 http://127.0.0.1:5000/graphql</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> graphqlHTTP = <span class="built_in">require</span>(<span class="string">'express-graphql'</span>);</span><br><span class="line"><span class="keyword">const</span> schema = <span class="built_in">require</span>(<span class="string">'./schema/schema'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/graphql'</span>, graphqlHTTP(&#123;</span><br><span class="line">  schema,</span><br><span class="line">  graphiql: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br><span class="line">app.listen(<span class="number">5000</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'now listening for requests on port 5000, http://127.0.0.1:5000/'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后在GraphiQL面板，查询对应book的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Graphiql的查询语句</span></span><br><span class="line">&#123;</span><br><span class="line">  book(id: "1") &#123;</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   <span class="string">"data"</span>: &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="string">"book"</span>: &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      <span class="string">"name"</span>: <span class="string">"Name of the Wind"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">     &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Graphql提供的类型-方法"><a href="#Graphql提供的类型-方法" class="headerlink" title="Graphql提供的类型/方法"></a>Graphql提供的类型/方法</h3><p><strong>GraphQLID</strong>，接受query中的字符串或数字类型的参数，转成JavaScript的string类型。<br><strong>GraphQLInt</strong>，number类型。<br><strong>GraphQLNonNull</strong>，使用方式<code>type: new GraphQLNonNull(GraphQLInt)</code>，说明该字段的数据类型为int且必填。</p>
<h3 id="关联类型（relative-type）"><a href="#关联类型（relative-type）" class="headerlink" title="关联类型（relative type）"></a>关联类型（relative type）</h3><p>把AuthorType作为BookType的关联类型（实现功能，每本书有个作者）</p>
<ul>
<li>声明一个字段<code>author</code>，类型为<code>AuthorType</code></li>
<li>在<code>resolve</code>中，参数<code>parent</code>带有当前query的返回结果，从数据库中查询<code>id</code>等于当前book的<code>authorId</code>的作者信息，作为<code>author</code>的返回值</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const <span class="type">BookType</span> = <span class="keyword">new</span> <span class="type">GraphQLObjectType</span>(&#123;</span><br><span class="line">  name: <span class="symbol">'Boo</span>k',</span><br><span class="line">  fields: () =&gt; (&#123;</span><br><span class="line">    id: &#123; <span class="class"><span class="keyword">type</span></span>: <span class="type">GraphQLID</span> &#125;,</span><br><span class="line">    genre: &#123; <span class="class"><span class="keyword">type</span></span>: <span class="type">GraphQLString</span> &#125;,</span><br><span class="line">    name: &#123; <span class="class"><span class="keyword">type</span></span>: <span class="type">GraphQLString</span> &#125;,</span><br><span class="line">    author: &#123;</span><br><span class="line">      <span class="class"><span class="keyword">type</span></span>: <span class="type">AuthorType</span>,</span><br><span class="line">      resolve(parent, args) &#123;</span><br><span class="line">        <span class="comment">// code to get data from db / other source</span></span><br><span class="line">        <span class="comment">// args.id</span></span><br><span class="line">        <span class="keyword">return</span> _.find(authors, &#123;</span><br><span class="line">          id: parent.authorId</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当关联类型需要返回一个数组</p>
<p>字段<code>books</code>返回<code>BookType</code>的数组，借助<code>GraphQLList</code>。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const <span class="type">AuthorType</span> = <span class="keyword">new</span> <span class="type">GraphQLObjectType</span>(&#123;</span><br><span class="line">  name: <span class="symbol">'Autho</span>r',</span><br><span class="line">  fields: () =&gt; (&#123;</span><br><span class="line">    id: &#123; <span class="class"><span class="keyword">type</span></span>: <span class="type">GraphQLID</span> &#125;,</span><br><span class="line">    name: &#123; <span class="class"><span class="keyword">type</span></span>: <span class="type">GraphQLString</span> &#125;,</span><br><span class="line">    age: &#123; <span class="class"><span class="keyword">type</span></span>: <span class="type">GraphQLInt</span> &#125;,</span><br><span class="line">    books: &#123;</span><br><span class="line">      <span class="class"><span class="keyword">type</span></span>: <span class="keyword">new</span> <span class="type">GraphQLList</span>(<span class="type">BookType</span>),</span><br><span class="line">      resolve(parent, args) &#123;</span><br><span class="line">        <span class="comment">// code to get data from db / other source</span></span><br><span class="line">        <span class="comment">// args.id</span></span><br><span class="line">        <span class="keyword">return</span> _.filter(books, &#123;</span><br><span class="line">          authorId: parent.id</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h3><p>数据库model的声明。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/author.js</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> Schema = mongoose.Schema;</span><br><span class="line"><span class="keyword">const</span> authorSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  age: <span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'Author'</span>, authorSchema);</span><br></pre></td></tr></table></figure>
<p>在GraphQL schema中声明mutation<code>addAuthor</code>方法，把model<code>Author</code>的实例保存到数据库，且<code>return</code>相应数据。</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// schema.js</span></span><br><span class="line">const Mutation = <span class="keyword">new</span> GraphQLObjectType(&#123;</span><br><span class="line">  name: 'Mutation',</span><br><span class="line">  fields: &#123;</span><br><span class="line">    addAuthor: &#123;</span><br><span class="line">      <span class="class"><span class="keyword">type</span>: <span class="title">AuthorType</span>,</span></span><br><span class="line">      args: &#123;</span><br><span class="line">        name: &#123; <span class="class"><span class="keyword">type</span>: <span class="title">GraphQLString</span> &#125;,</span></span><br><span class="line">        age: &#123; <span class="class"><span class="keyword">type</span>: <span class="title">GraphQLInt</span> &#125;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      resolve(parent, args) &#123;</span><br><span class="line">        <span class="comment">// 创建mongoose model `Author` 实例</span></span><br><span class="line">        <span class="keyword">let</span> author = <span class="keyword">new</span> Author(&#123;</span><br><span class="line">          name: args.name,</span><br><span class="line">          age: args.age</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mongoose model 实例的方法</span></span><br><span class="line">        <span class="keyword">return</span> author.save();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在GraphiQL中调用该mutation，执行添加author的操作，且获取添加后的数据结果。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// GraphiQL</span><br><span class="line">mutation &#123;</span><br><span class="line">  addAuthor(name: <span class="string">"wyy"</span>, age: <span class="number">28</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    age</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 返回结果</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"data"</span>: &#123;</span><br><span class="line">    <span class="string">"addAuthor"</span>: &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"wyy"</span>,</span><br><span class="line">      <span class="string">"age"</span>: <span class="number">28</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><h3 id="环境-1"><a href="#环境-1" class="headerlink" title="环境"></a>环境</h3><ul>
<li>React.js<ul>
<li>create-react-app</li>
</ul>
</li>
<li>Apollo系<ul>
<li>apollo-boost</li>
<li>graphql</li>
<li>react-apollo</li>
</ul>
</li>
</ul>
<h3 id="Step-1：连接React-component和Apollo-Provider"><a href="#Step-1：连接React-component和Apollo-Provider" class="headerlink" title="Step 1：连接React component和Apollo Provider"></a>Step 1：连接React component和Apollo Provider</h3><p>在整个React应用中，通过ApolloClient，打通graphql和react组件的连接。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.js</span></span><br><span class="line"><span class="keyword">import</span> ApolloClient <span class="keyword">from</span> <span class="string">'apollo-boost'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApolloProvider &#125; <span class="keyword">from</span> <span class="string">'react-apollo'</span>;</span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> ApolloClient(&#123;</span><br><span class="line">  uri: <span class="string">'http://localhost:5000/graphql'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ApolloProvider client=&#123;client&#125;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;h1&gt;hello, world&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">          &lt;BookList /</span>&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ApolloProvider&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step-2：graphql-query和React组件的数据交互"><a href="#Step-2：graphql-query和React组件的数据交互" class="headerlink" title="Step 2：graphql query和React组件的数据交互"></a>Step 2：graphql query和React组件的数据交互</h3><h4 id="1-声明graphql-query"><a href="#1-声明graphql-query" class="headerlink" title="1.声明graphql query"></a>1.声明graphql query</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/BookList.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; gql &#125; <span class="keyword">from</span> <span class="string">'apollo-boost'</span>;</span><br><span class="line"><span class="keyword">const</span> getBooksQuery = gql<span class="string">`</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  books &#123;</span></span><br><span class="line"><span class="string">    id</span></span><br><span class="line"><span class="string">    name</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>
<h4 id="2-利用Apollo连接gq-query和react-component"><a href="#2-利用Apollo连接gq-query和react-component" class="headerlink" title="2.利用Apollo连接gq query和react component"></a>2.利用Apollo连接<code>gq query</code>和react component</h4><p>结合<code>react-apollo</code>的<code>graphql</code>，以及刚才声明的query，把请求数据打进<code>BookList</code>的<code>props</code>。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; graphql &#125; from <span class="symbol">'react</span>-apollo';</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 具体组件实现 blah blah</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> graphql(getBooksQuery)(<span class="type">BookList</span>);</span><br></pre></td></tr></table></figure>
<p>假如，在一个组件内，需要注入多个query，可以利用<code>react-apollo</code>提供的<code>compose</code>方法。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; graphql, compose &#125; from <span class="symbol">'react</span>-apollo';</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 具体组件实现 blah blah</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> compose(</span><br><span class="line">  graphql(gqlQuery1, &#123; name: <span class="symbol">'gqlQuery</span>1' &#125;),</span><br><span class="line">  graphql(gqlQuery2, &#123; name: <span class="symbol">'gqlQuery</span>2' &#125;),</span><br><span class="line">)(<span class="type">BookList</span>);</span><br></pre></td></tr></table></figure>
<p><img src="http://sinacloud.net/woodysblog/graphql/gql-compose.png" alt="&quot;graphql compose&quot;"></p>
<h4 id="3-通过this-props-data获取请求数据"><a href="#3-通过this-props-data获取请求数据" class="headerlink" title="3.通过this.props.data获取请求数据"></a>3.通过this.props.data获取请求数据</h4><p>在server的graphiQL查询的数据结构如下。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"books"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"5b374cdd5806e47eefce3734"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"test"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在render输出client的this.props.data，可以发现props更新了两次。区别在于<code>loading</code>这个字段，这也可以作为一个判断的flag，当<code>loading</code>为<code>true</code>时，再进一步分析接口返回的数据结构。</p>
<p>第一次，<code>loading</code>为<code>true</code>，没有<code>books</code>这个字段。</p>
<p><img src="http://sinacloud.net/woodysblog/graphql/apollo-loading.png" alt="&quot;loading&quot;"></p>
<p>第二次，<code>loading</code>为<code>false</code>，而<code>books</code>返回了一个数组。</p>
<p><img src="http://sinacloud.net/woodysblog/graphql/apollo-loaded.png" alt="&quot;loaded&quot;"></p>
<h4 id="4-Mutation"><a href="#4-Mutation" class="headerlink" title="4. Mutation"></a>4. Mutation</h4><p>i. query的声明</p>
<p>值得注意的是，当调用mutation时，我们可能需要传入参数，如何获取从react组件传入的参数？可以利用query variables（query变量）实现。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// query.js</span></span><br><span class="line">const addBookMutation = gql`</span><br><span class="line"><span class="function"><span class="title">mutation</span><span class="params">(<span class="variable">$name</span>: String!, <span class="variable">$genre</span>: String!, <span class="variable">$authorId</span>: ID!)</span></span> &#123;</span><br><span class="line">  addBook(name: <span class="variable">$name</span>, genre: <span class="variable">$genre</span>, authorId: <span class="variable">$authorId</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    id</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>ii. react component的数据交互</p>
<p>利用<code>react-apollo</code>的<code>compose</code>，把<code>addBookMutation</code>注入到<code>this.props</code>，通过<code>varibales</code>传入query变量。</p>
<p>而当我们希望在mutation之后重新获取某个query的数据时，可以在mutation操作中添加<code>refetchQueries</code>的回调。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addBook.js</span></span><br><span class="line"><span class="function"><span class="title">addBook</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// formData为点击表单提交后，获取各项input/select的数据对象</span></span><br><span class="line">  this<span class="selector-class">.props</span><span class="selector-class">.addBookMutation</span>(&#123;</span><br><span class="line">    variables: &#123;</span><br><span class="line">      name: formData<span class="selector-class">.name</span>,</span><br><span class="line">      genre: formData<span class="selector-class">.genre</span>,</span><br><span class="line">      authorId: formData<span class="selector-class">.authorId</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    refetchQueries: [&#123;</span><br><span class="line">      query: anotherQueryWantedToBeRefetched</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-Query"><a href="#5-Query" class="headerlink" title="5. Query"></a>5. Query</h4><p>需要从组件传入参数，进行参数查询的gql query（引入query变量）。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// query.js</span></span><br><span class="line"><span class="keyword">const</span> getBooksQuery = gql`</span><br><span class="line">query ($<span class="keyword">id</span>: ID!) &#123;</span><br><span class="line">  book(<span class="keyword">id</span>: $<span class="keyword">id</span>) &#123;</span><br><span class="line">    <span class="keyword">id</span></span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getBook.js</span></span><br><span class="line"><span class="comment">// 在绑定组件和graphql数据前，把props.id注入到query的variables里</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> graphql(getBookQuery, &#123;</span><br><span class="line">  options: props =&gt; (&#123;</span><br><span class="line">    variables: &#123;</span><br><span class="line">      <span class="keyword">id</span>: props.id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)(getBookComponentName);</span><br></pre></td></tr></table></figure>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p><code>问</code> 为什么在声明GraphQLObjectType实例时，fields不直接使用对象，而使用了函数？<br><code>答</code> 因为js的执行时机，直接使用对象的话，代码从上往下执行，fields中引用别的类型，如BookType和AuthorType有互相引用，会报错BookType或者AuthorType undefined。而使用函数的话，执行到函数内部逻辑时，外部的声明已经完成了。</p>

		</div>

		<footer>
			
	<section class="post__meta post__tag">
		
			<a href="/blog/tags/front-end/">front-end</a>
		
			<a href="/blog/tags/graphql/">graphql</a>
		
	</section>

			<section class="post__meta">
	<a href="/blog/donate.html" title="码字辛苦求打赏" class="u-clearfix wgt-shield">
		<span class="title">Donate</span>
		<span class="desc">￥￥￥</span>
	</a>

	<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" 
		title="知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议" class="u-clearfix wgt-shield">
		<span class="title">License</span>
		<span class="desc">CC BY-NC-SA</span>
	</a>
</section>
		</footer>

		
			<section id="wgt-comment" class="wgt-comment" data-permalink="/archives/graphql/">
	<div id="comment-list">
		<article>暂无数据</article>
	</div>

	<form id="comment-form" class="comment__form">
		<input type="text" 
			name="author" 
			class="comment--mb10 comment__contentAuthor" 
			required 
			max-length="15"
			placeholder="这里输入你的名字" />
		<input type="text" 
			name="content" 
			class="comment--mb10 comment__contentInput" 
			required
			max-length="150"
			placeholder="这里输入评论内容" />
		<input type="hidden" name="parentId" id="comment-reply-id" />
		<!-- <label>
			<span>Email: </span>
			<input type="email" name="email">
		</label>
		<label>
			<span>website: </span>
			<input type="url" name="website">
		</label> -->

		<footer class="comment--clearfix comment--tRight" id="comment-form-footer">
			<a id="comment-box-submit" class="comment--fontsizeMeta comment--colorAccent comment__submitReply">加上去</a>
		</footer>
	</form>
</section>
		
	</div>
</article>

		</div>
		
	</div>
</div>

<link rel="stylesheet" href="/blog//build/css/iconfont_201704181501.css">


	<footer class="wgt-footer" id="footer">
	<div class="center">
		<p>
		&copy; 
		2014-2018

		
			<a href="/blog/">Yuying Wu</a>
		

		&nbsp;|&nbsp;
		<a href="https://github.com/YuyingWu"><i class="iconfont icon-github"></i> Github</a>&nbsp;|&nbsp;
<a href="http://www.weibo.com/wuyuying1128"><i class="iconfont icon-weibo"></i> 微博</a>&nbsp;|&nbsp;
<a href="http://www.douban.com/people/wuyuying1128/"><i class="iconfont icon-douban"></i>豆瓣</a>
		</p>
		<p>
			京ICP备16019960号&nbsp;
			Powered by 
			<a href="https://hexo.io" target="_blank">Hexo</a>, using theme 
			<a href="https://github.com/YuyingWu/hexo-theme-fresh" 
				target="_blank">Fresh</a>
		.</p>
	</div>
</footer>



<script src="http://cdn1.lncld.net/static/js/2.1.4/av-min.js"></script>
<script src="http://apps.bdimg.com/libs/zepto/1.1.4/zepto.min.js"></script>
<script src="http://cdn.bootcss.com/moment.js/2.18.1/moment.min.js"></script>
<script src="/blog//build/js/comment.js"></script>


<script src="//sinacloud.net/woodysblog/statics/lazyload.js"></script>
<script>
	new LazyLoad({
		threshold: 600
	});
</script>
<script src="/blog//dist/base.js"></script>
</body>
</html>