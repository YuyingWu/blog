---
title: 浅谈 React Error Boundaries
categories: [tech]
tags: [react]
date: 2019-11-18 18:19:18
---

前几天面试候选人的时候，有提到用`React 16.x`重构了一个电商首页，对各个业务模块做更细颗粒拆解和代码组织，提升开发效率和降低维护成本，在这里要给小同学点个赞，有想法也有落地成果。后来问及“一个模块报错，搞挂了整个页面”的问题，大家都知道，如果页面的entry是index.js，在里面引入各个components的话，运行时只要有一行代码挂了，整个js都会挂掉。针对这个问题，除了前端同学的自测、QA同学的测试或者人肉的code review，有没有代码层面或者机制，做好模块间的错误隔离/处理/上报？比较遗憾的是，在生产环境下，候选人没有针对这个线上大流量页面做相关的处理，靠人肉规范，没能给出比较好的错误隔离的设计思路和实践方案。

其实相关的思路可以有很多种，模块/页面级的异常处理、commit前跑test case、提交后或者发布前headless检查页面报错，等等。

笔者之前写过一篇[《这！就是1688 PC首页》](http://www.wuyuying.com/1688-pc-home/)，里面有提到我们团队基于React 16.x的页面实践，一个 index.jsx 中引入子目录下的各种 components ，初期开发阶段，整个应用处于“裸奔”的状态，一个组件抛错误，整个页面都会挂掉。日常抛JS error的情况包括但不限于代码逻辑没注意写错了、数据接口挂了或者返回结构不如预期、多层数据获取的容错等。首页有19个组件和一些公用的函数，如果其中一处报错，会把整个页面搞挂，风险太大。最后选用了React 16的Error Boundaries（错误边界）API去做components之间的容错隔离/错误上报的。

## Why Error Boundaries?

[React 16官方文档 —— 错误边界 >>](https://zh-hans.reactjs.org/docs/error-boundaries.html)

> 过去，组件内的 JavaScript 错误会导致 React 的内部状态被破坏，并且在下一次渲染时 产生 可能无法追踪的 错误。这些错误基本上是由较早的其他代码（非 React 组件代码）错误引起的，但 React 并没有提供一种在组件中优雅处理这些错误的方式，也无法从错误中恢复。
>   
> 部分 UI 的 JavaScript 错误不应该导致整个应用崩溃，为了解决这个问题，React 16 引入了一个新的概念 —— 错误边界。  
>   
> 错误边界是一种 React 组件，这种组件可以捕获并打印发生在其子组件树任何位置的 JavaScript 错误，并且，它会渲染出备用 UI，而不是渲染那些崩溃了的子组件树。错误边界在渲染期间、生命周期方法和整个组件树的构造函数中捕获错误。

